{% extends "base.html.jinja" %}
{% block title %}{{resource.name}}{% endblock %}

{% block content%}
<div class="container">
    <header class="player u-mt">
        <h1 class="h2"><a href="{{url_for('resource-detail', resource_id=resource.id)}}">{{resource.name}}</a></h1>
        <span class="player__right">{{resource.duration|duration_format}}</span>
        <span>
            <a
                href="{{url_for('collection-detail', collection_id=resource.collection.id)}}">{{resource.collection.name}}</a>
        </span>
    </header>

    {% if resource.is_video() %}
    <video id="media-element" class="u-mt" controls width="700" poster="{{resource.poster_url}}">
        <source src="{{resource.url}}" type="{{resource.media_type}}" />
    </video>
    {% else %}
    <audio id="media-element" class="audio u-mt" controls width="700" poster="{{resource.poster_url}}">
        <source src="{{resource.url}}" type="{{resource.media_type}}" />
    </audio>
    {% endif %}

    <div class="grid u-mt">
        {% if resource.toc %}
        <div>
            <ul class="base-list">
                {% for entry in resource.toc %}
                <li>
                    <a href="#{{entry.position}}">{{entry.name}} ({{entry.position|duration_format}})</a>
                </li>
                {% endfor %}
            </ul>
        </div>
        {% endif %}
        <div>
            <fieldset>
                <legend>Set playback rate:</legend>
                <div class="u-display-flex">
                <div>
                    <label>
                        <input type="radio" id="slow" name="rate" value="slow" />
                        Slow
                    </label>
                </div>
                <div>
                    <label>
                        <input type="radio" id="normal" name="rate" value="normal" checked />
                        Normal
                    </label>
                </div>
                <div>
                    <label>
                        <input type="radio" id="fast" name="rate" value="fast" />
                        Fast
                    </label>
                </div>
                </div>
            </fieldset>
            <p class="u-mt">
                <button id="set-marker" type="button">Set marker</button>
            </p>
            <p id="marker-place" class="marker-place u-mt-tiny"></p>
        </div>
    </div>
</div>
{% endblock %}
{% block javascript %}
<script>
    const PLAYBACK_RATE_SLOW = 0.8;
    const PLAYBACK_RATE_NORMAL = 1.0;
    const PLAYBACK_RATE_FAST = 1.25;

    const setMarker = document.getElementById('set-marker');
    const markerPlace = document.getElementById('marker-place');
    const mediaElement = document.getElementById('media-element');
    const slowPlaybackRate = document.getElementById('slow');
    const normalPlaybackRate = document.getElementById('normal');
    const fastPlaybackRate = document.getElementById('fast');

    const tocButtons = Array.from(document.getElementsByClassName('toc-button'));

    function togglePlay() {
        if (mediaElement.paused || mediaElement.ended) {
            mediaElement.play();
        } else {
            mediaElement.pause();
        }
    }

    document.addEventListener("keydown", (e) => {
        if (['Space', 'ArrowLeft', 'ArrowRight', 'KeyM', 'KeyF'].includes(e.code)) {
            e.preventDefault();
        }
        let newTime;
        switch (e.code) {
            case 'Space':
                togglePlay();
                break;
            case 'ArrowLeft':
                newTime = mediaElement.currentTime - 5;
                mediaElement.currentTime = newTime;
                break;
            case 'ArrowRight':
                newTime = mediaElement.currentTime + 10;
                mediaElement.currentTime = newTime;
                break;
            case 'KeyM':
                mediaElement.muted = !mediaElement.muted;
                break;
            case 'KeyF':
                if (mediaElement.tagName === 'VIDEO' && document.fullscreenEnabled) {
                    if (document.fullscreenElement) {
                        document.exitFullscreen();
                    } else {
                        mediaElement.requestFullscreen();
                    }
                }
            default:
        }
    });

    document.addEventListener('DOMContentLoaded', (event) => {
        const url = new URL(document.URL);
        const hash = url.hash;
        const seconds = Number.parseFloat(hash.slice(1));
        if (typeof seconds === 'number' && !Number.isNaN(seconds)) {
            mediaElement.currentTime = seconds;
        }
    });

    window.addEventListener('hashchange', (event) => {
        const url = new URL(event.newURL);
        const hash = url.hash;
        const seconds = Number.parseFloat(hash.slice(1));
        if (typeof seconds === 'number') {
            mediaElement.currentTime = seconds;
            mediaElement.play();
        }
    })

    function handleTocButtonClick(event) {
        const time = Number.parseFloat(this.dataset.position);
        mediaElement.currentTime = time;
    }

    slowPlaybackRate.addEventListener('click', () => mediaElement.playbackRate = PLAYBACK_RATE_SLOW);
    normalPlaybackRate.addEventListener('click', () => mediaElement.playbackRate = PLAYBACK_RATE_NORMAL);
    fastPlaybackRate.addEventListener('click', () => mediaElement.playbackRate = PLAYBACK_RATE_FAST);
    tocButtons.forEach(button => button.addEventListener('click', handleTocButtonClick));

    function positionFormat(seconds) {
        hours = Math.floor(seconds / 3600);
        minutes = Math.floor((seconds % 3600) / 60);
        secs = Math.floor(seconds % 60);

        if (hours === 0) {
            return `${minutes}m${secs}s`;
        } else {
            return `${hours}h${minutes}m${secs}s`;
        }
    }

    function insertButton(container, newButton) {
        const children = Array.from(container.children);

        if (children.length === 0) {
            container.append(newButton);
            return;
        }

        for (let i = 0; i < children.length; i++) {
            if (i === children.length - 1) {
                children[i].after(newButton);
                break;
            }

            const currentButtonPos = Number.parseFloat(children[i].dataset.position);
            const nextButtonPos = Number.parseFloat(children[i + 1]?.dataset?.position);
            const newButtonPos = Number.parseFloat(newButton.dataset.position);

            if (newButtonPos >= currentButtonPos && newButtonPos < nextButtonPos) {
                children[i].after(newButton);
                break;
            }
        }
    }

    function handleSetMarker(event) {
        const position = mediaElement.currentTime;
        const button = document.createElement('button');
        button.textContent = positionFormat(position);
        button.dataset.position = position.toString();
        button.addEventListener('click', handleButtonClick);
        insertButton(markerPlace, button);
    }

    function handleButtonClick(event) {
        if (event.shiftKey) {
            this.remove();
        } else {
            const position = Number.parseFloat(this.dataset.position);
            mediaElement.currentTime = position;
            mediaElement.play();
        }
    }

    setMarker.addEventListener('click', handleSetMarker);
</script>
{% endblock %}
